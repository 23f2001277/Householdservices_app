@app.route("/book/<int:professional_id>", methods=["POST", "GET"])
def book_professional(professional_id):
    try:
        # Retrieve data from form and session
        service_id = request.form.get("service_id")
        customer_id = session.get("user_id")

        # Debugging output
        print(f"Customer ID: {customer_id}, Service ID: {service_id}, Professional ID: {professional_id}")

        if not customer_id:
            flash("Please log in to book a service.", "error")
            return redirect(url_for("login"))

        professional = Prof_Info.query.get(professional_id)
        service = Service.query.get(service_id)

        # Validations
        if not professional or not service:
            flash("Invalid professional or service selected.", "error")
            return redirect(url_for("user_dashboard"))

        if professional.prof_status == 'blocked':
            flash("This professional is not available for booking.", "error")
            return redirect(url_for("user_dashboard"))

        # Create a new service request
        service_request = Service_req(
            service_id=service.id,
            cust_id=customer_id,
            prof_id=professional.id,
            date_of_req=datetime.now(),
            status="pending"  # Default status
        )
        
        # Add and commit the service request to the database
        db.session.add(service_request)
        db.session.commit()

        # Link the service request to the user's service history
        user_service_history = User_Service_History(
            user_id=customer_id,
            service_req_id=service_request.id
        )
        db.session.add(user_service_history)
        db.session.commit()

        flash(f"Service '{service.name}' booked successfully with {professional.full_name}!", "success")
        return redirect(url_for("user_dashboard"))

    except Exception as e:
        # Handle any unexpected errors
        db.session.rollback()
        flash("An error occurred while booking the service. Please try again.", "error")
        print(f"Error: {e}")  # For debugging (remove in production)
        return redirect(url_for("user_dashboard"))



















        @app.route("/book/<int:professional_id>", methods=["POST"])
def book_professional(professional_id):
    service_id = request.form["service_id"]
    customer_id = session["user_id"]
    professional = Prof_Info.query.get(professional_id)
    if professional.prof_status == 'blocked':
        flash("This professional is not available for booking.", "error")
        return redirect(url_for("user_dashboard"))
    service = Service.query.get(service_id)
    
    # Create a new Service_req record
    service_request = Service_req(
        service_id=service_id,
        cust_id=customer_id,
        prof_id=professional.id,
        date_of_req=datetime.now(),
        status=STATUS_PENDING
    )
    
    # Add the service request to the database
    db.session.add(service_request)
    db.session.commit()
    
    # Now link the service request to the user's service history
    user_service_history = User_Service_History(
        user_id=customer_id,
        service_req_id=service_request.id
    )
    db.session.add(user_service_history)
    db.session.commit()
    
    flash("Service booked successfully!")
    return redirect(url_for("user_dashboard"))






    {% extends "user_layout.html" %}
{% block content %}
<html>
    <p class="trs" style="text-align: center; font-size: 30px;">Our top-rated services</p>
    <div class="container">
        <div class="row">
            <!-- Existing service cards -->
        </div>

        <div class="container mt-5">
            <h2 style="text-align: center;">Service History</h2>
            <table class="table table-bordered table-striped mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Service Name</th>
                        <th>Professional Name</th>
                        <th>Phone No.</th>
                        <th>Date of Request</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history, service_req, service in user_service_history %}
                    <tr>
                        <td>{{ service_req.id }}</td>
                        <td>{{ service.name }}</td>
                        <td>{{ service_req.professional.full_name }}</td>
                        <td>{{ service_req.professional.phone }}</td>
                        <td>{{ service_req.date_of_req.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if service_req.status == 'pending' %}
                            <span class="badge badge-warning">Pending</span>
                            {% elif service_req.status == 'accepted' %}
                            <span class="badge badge-success">Accepted</span>
                            {% elif service_req.status == 'rejected' %}
                            <span class="badge badge-danger">Rejected</span>
                            {% else %}
                            {{ service_req.status }}
                            {% endif %}
                        </td>
                        <td>
                            {% if service_req.status == 'accepted' %}
                            <form action="{{ url_for('close_service', service_req_id=service_req.id) }}" method="get" style="display: inline;">
                                <button type="submit" class="btn btn-warning">Close It</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</html>
{% endblock %}
